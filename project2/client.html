<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>DHT22 Sensor</title>
	
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style>
	* {
	  box-sizing: border-box;
	}

	body {
	  font-family: Arial, Helvetica, sans-serif;
	}

	/* Style the header */
	header {
	  background-color: #666;
	  padding: 30px;
	  text-align: center;
	  font-size: 35px;
	  color: white;
	}

	/* Create two columns/boxes that floats next to each other */
	nav {
	  float: left;
	  width: 30%;
	  height: 500px; /* only for demonstration, should be removed */
	  background: #ccc;
	  padding: 20px;
	}

	/* Style the list inside the menu */
	nav ul {
	  list-style-type: none;
	  padding: 0;
	}

	article {
	  float: left;
	  padding: 20px;
	  width: 70%;
	  background-color: #f1f1f1;
	  height: 500px; /* only for demonstration, should be removed */
	}

	/* Clear floats after the columns */
	section:after {
	  content: "";
	  display: table;
	  clear: both;
	}

	/* Style the footer */
	footer {
	  background-color: #777;
	  padding: 50px;
	  text-align: center;
	  color: white;
	}

	/* Responsive layout - makes the two columns/boxes stack on top of each other instead of next to each other, on small screens */
	@media (max-width: 600px) {
	  nav, article {
		width: 100%;
		height: auto;
	  }
	}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	
	<script>
		   // log information to  function
		  log = function(data){
			$("footer").prepend("</br>" +data);
		  };
		  
		  convert_temp = function(){
			//read value from OutputScreen2
			var str = $('#OutputScreen2').text();
			var res = str.split(":");
			var temp = res[1]
			//parse out value
			var n = temp.search("C")
			if (n >1){
				temp = temp.split("*")[0] 
				temp = (temp*(9/5))+32+ '*F'
				temp = 'Temperature : '+ temp
			}
			else {
				temp = temp.split("*")[0] 
				temp = (temp-32)*(5/9)+ '*C'
				temp = 'Temperature : '+ temp	
			}
			
			//print out to outputscreen 2
			$('#OutputScreen2').text(temp);
		  };
		  

		  
		  //proceed once web page has loaded
		  $(document).ready(function () {
			
	 
			var ws;
	 
	 
			//---------------------------python app socket handler--------------------------------
			
			// create websocket instance to python application on port 8888
			ws = new WebSocket('ws://localhost:8888/ws');
			   
			// Handle incoming websocket message from python application
			ws.onmessage = function(evt) {
				console.log("Message Received from tornado: " + evt.data);
				$('#SourceScreen').text('Reply from Python app: ');
				var str = evt.data
				var res = str.split("/");
				var time = res[0]
				var temp = res[1]
				var humidity = res[2]	
				$('#OutputScreen1').text(time);
				$('#OutputScreen2').text(temp);
				$('#OutputScreen3').text(humidity);
			  };
	 
			// Close Websocket callback
			ws.onclose = function(evt) {
			  console.log("***Tornado Server Connection Closed***");
			  log("***Tornado Server Connection Closed***");
			  };
	 
			// Open Websocket callback
			ws.onopen = function(evt) { 
			  log("***Tornado Server Connection Opened**");
			  };
			
	 
			// Send command to query sensor data from python application
			read_from_pythonapp = function(){
				console.log("Sending command to read last value from node.js server");
				ws.send('Read one from db');
				
			};
	 
			  
			//open websocket to node js/sql server
			
			//---------------------------node js socket handler--------------------------------
			
			const node_ws = new WebSocket('ws://localhost:8080');
			node_ws.onopen = function() {
				console.log('WebSocket Client Connected');
				log("***Node_js/mySQL Connection Opened**");
			};
			node_ws.onmessage = function(e) {
				console.log("Received: '" + e.data + "'");
				$('#SourceScreen').text('Reply from Node.js: ');
				$('#OutputScreen').text(e.data);
			};
			  
			node_ws.onclose = function(e) {
				log("***Node_js/mySQL Connection Closed***");
			}
			node_ws.onerror = (error) => {
				console.log(`WebSocket error: ${error}`);
			};
			
			// Send command to query last entry in sql database via node.js server 
			read_from_nodejs = function(){
				console.log("Sending command to read last value from node.js server");
				node_ws.send('Read one from db');
				
			};
			
			
	   });
	</script>
	</head>
	
	<body>
		<header>
		  <h2>DHT22 Sensor Web Interface</h2>
		</header>

		<section>
		  <nav>
			<ul>
				<button type="button" onclick="read_from_nodejs()">Read last sensordatabase entry from Node.js.</button>
				<button type="button" onclick="read_from_pythonapp()">Read sensor data from python application.</button>
				<button type="button" onclick="convert_temp()">Convert Temperature Celsius/Fahrenheit</button>
				<button type="button" onclick="alert(&#39;Hello world!&#39;)">Click Me!</button>
			</ul>
		  </nav>
		  
		  <article>
			<h1>Output</h1>
			<div id="SourceScreen">
			<p></p>
			</div>
			<div id="OutputScreen1">
			<p>Results of each button click will appear here.</p>
			</div>
			<div id="OutputScreen2">
			<p></p>
			</div>
			<div id="OutputScreen3">
			<p></p>
			</div>
			
		  </article>
		</section>

		<footer>
		  <p>status</p>
		</footer>


	</body>

</html>
